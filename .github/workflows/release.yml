name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  # ──────────────────────────────────────────────
  # Validate: Full build, typecheck, and test before publishing
  # ──────────────────────────────────────────────
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: TypeScript type checking
        run: npm run typecheck

      - name: Run tests
        run: npx vitest run

  # ──────────────────────────────────────────────
  # Tier 1: Foundation packages with no internal dependencies
  # ──────────────────────────────────────────────
  publish-foundation:
    name: "Publish @stele/${{ matrix.package }}"
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      matrix:
        package: [types, crypto]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Publish @stele/${{ matrix.package }}
        run: npm publish --provenance --access public
        working-directory: packages/${{ matrix.package }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ──────────────────────────────────────────────
  # Tier 2: Core packages that depend on foundation
  # ──────────────────────────────────────────────
  publish-core:
    name: "Publish @stele/${{ matrix.package }}"
    needs: publish-foundation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      matrix:
        package: [core, store, verifier]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Publish @stele/${{ matrix.package }}
        run: npm publish --provenance --access public
        working-directory: packages/${{ matrix.package }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ──────────────────────────────────────────────
  # Tier 3: SDK, CLI, integrations, and protocol packages
  # ──────────────────────────────────────────────
  publish-ecosystem:
    name: "Publish @stele/${{ matrix.package }}"
    needs: publish-core
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        package:
          - ccl
          - sdk
          - cli
          - enforcement
          - identity
          - reputation
          - breach
          - proof
          - mcp
          - mcp-server
          - react
          - evm
          - discovery
          - schema
          - attestation
          - canary
          - gametheory
          - composition
          - antifragile
          - negotiation
          - consensus
          - robustness
          - temporal
          - recursive
          - alignment
          - norms
          - substrate
          - derivatives
          - legal
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Publish @stele/${{ matrix.package }}
        run: npm publish --provenance --access public
        working-directory: packages/${{ matrix.package }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ──────────────────────────────────────────────
  # Verify: Confirm all packages are live on npm
  # ──────────────────────────────────────────────
  verify:
    name: Verify Published Packages
    needs: [publish-foundation, publish-core, publish-ecosystem]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Extract expected version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Wait for npm registry propagation
        run: sleep 30

      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify all packages on npm
        run: |
          # Auto-discover packages from the packages/ directory
          packages=()
          for pkg_dir in packages/*/; do
            packages+=("$(basename "$pkg_dir")")
          done
          expected="${{ steps.version.outputs.version }}"
          passed=0
          failed=0

          echo "Verifying packages for version: ${expected}"
          echo ""

          for pkg in "${packages[@]}"; do
            published=$(npm view "@stele/${pkg}" version 2>/dev/null || echo "NOT_FOUND")
            if [ "$published" = "$expected" ]; then
              echo "[PASS] @stele/${pkg}@${published}"
              passed=$((passed + 1))
            else
              echo "[FAIL] @stele/${pkg} - expected ${expected}, got ${published}"
              failed=$((failed + 1))
            fi
          done

          echo ""
          echo "Results: ${passed} passed, ${failed} failed out of ${#packages[@]} packages"

          if [ "$failed" -gt 0 ]; then
            echo "::error::${failed} package(s) failed version verification"
            exit 1
          fi
